<?php
// --------------------------------------------------------------------------
namespace App\Http\Controllers\Frontend\Customer;
use App\Http\Controllers\Controller;
// --------------------------------------------------------------------------
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
// --------------------------------------------------------------------------
use App\Models\ActionType as Action;
use App\Models\CustomerLogActivity as Log;
// --------------------------------------------------------------------------

// --------------------------------------------------------------------------
class CustomerHistoryController extends Controller {
    // ----------------------------------------------------------------------
    // Base view
    // ----------------------------------------------------------------------
    public function index(){ return view( 'frontend.history.index' );}
    // ----------------------------------------------------------------------


    // ----------------------------------------------------------------------
    // Page filters
    // ----------------------------------------------------------------------
    public function filter( Request $request ){
        // ------------------------------------------------------------------
        $response = new \stdClass;
        $response->status = 'success';
        // ------------------------------------------------------------------
        $filter = (object) $request->filter ?? null;
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Pagination parameters
        // ------------------------------------------------------------------
        $perpage = 10;
        $page = $filter->page ?? 1;
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Base query
        // ------------------------------------------------------------------
        $customerID = Auth::guard('user')->user()->id;
        $query = Log::has('property')->where( 'customers_id', $customerID )
            ->where( 'action_types_id', Action::PROPERTY_BROWSING );
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Relationhip
        // ------------------------------------------------------------------
        $relations = collect([ 'property.photos.file' ]);
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        // Paginate the result
        // ------------------------------------------------------------------
        $query->with( $relations->unique()->all());
        $paginator = $query->paginate( $perpage, ['*'], 'page', $page );
        $response->result = $paginator;
        // ------------------------------------------------------------------

        // ------------------------------------------------------------------
        return response()->json( $response, 200, [], JSON_NUMERIC_CHECK );
        // ------------------------------------------------------------------
    }
    // ----------------------------------------------------------------------
}
// --------------------------------------------------------------------------